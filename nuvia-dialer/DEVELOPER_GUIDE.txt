NUVIA DIALER ‚Äî INTERNAL DEVELOPER GUIDE

This document provides a detailed technical overview and step-by-step instructions for setting up, maintaining, and extending the **Nuvia Dialer** application.

---

## üß± Architecture Overview

```

Agent Browser ‚Üí Frontend (HTML/CSS/JS)
‚Üì HTTPS
Render Static Site
‚Üì
Render Backend (FastAPI)
‚Üì HTTPS / WS
Five9 Cloud (REST + WS APIs)
‚Üì
GoHighLevel (contact links)

````

- **Frontend**: Static site hosted on Render, all dialer UI and animations.
- **Backend**: FastAPI proxy between the browser and Five9 APIs (keeps credentials secure).
- **Five9**: Provides call control, campaign, and agent status APIs.
- **GoHighLevel**: Used for automatic contact lookup and CRM linking.

---

## ‚öôÔ∏è Local Dev Setup

### 1Ô∏è‚É£ Clone and install
```bash
git clone https://github.com/<your-org>/nuvia-dialer.git
cd nuvia-dialer/backend
pip install -r requirements.txt
````

### 2Ô∏è‚É£ Run backend

```bash
uvicorn main:app --reload
```

### 3Ô∏è‚É£ Run frontend

```bash
cd ../frontend
python3 -m http.server 8080
```

Open [http://localhost:8080](http://localhost:8080) in your browser.

---

## üß© Environment Variables

| Key                   | Description                                                    |
| --------------------- | -------------------------------------------------------------- |
| `FIVE9_CLIENT_ID`     | Five9 API client ID                                            |
| `FIVE9_CLIENT_SECRET` | Five9 API client secret                                        |
| `ALLOWED_ORIGIN`      | Frontend URL allowed to make API calls (use `*` for localhost) |

Set these in `.env` (for local testing) or in Render's **Environment Settings**.

---

## üîê Authentication Flow

1. Agents log in through the frontend (username/password).
2. Frontend sends credentials to `/api/login`.
3. Backend exchanges credentials for an **OAuth2 token** with Five9.
4. Frontend stores the token temporarily in memory.
5. Token is used for all Five9 API calls (expires every 60 minutes).

The credentials never touch the client beyond the initial HTTPS post.

---

## ‚òéÔ∏è API Endpoints Summary

| Route                      | Method | Description                                        |
| -------------------------- | ------ | -------------------------------------------------- |
| `/api/login`               | POST   | Exchange agent credentials for a Five9 OAuth token |
| `/api/agent/state`         | GET    | Retrieve current agent status                      |
| `/api/campaigns/for-skill` | GET    | Detect skill ‚Üí assign matching outbound campaign   |
| `/api/call`                | POST   | Initiate outbound call via Five9 Agent API         |
| `/ws`                      | WS     | Stream Five9 agent events (currently simulated)    |

---

## üîß Connect to Real Five9 WebSocket

The placeholder `/ws` simulates events.
To use live data, connect to **Five9 Agent Streaming API**:

```python
import websockets, asyncio

async def stream_five9(ws):
    five9_ws_url = "wss://api.five9.com/agent/v2/stream"
    headers = {"Authorization": f"Bearer {LIVE_AGENT_TOKEN}"}
    async with websockets.connect(five9_ws_url, extra_headers=headers) as five9:
        async for message in five9:
            await ws.send_text(message)
```

Replace your `/ws` implementation in `main.py` with a relay like above.
Make sure you use the same agent‚Äôs live OAuth token (from `/api/login`).

---

## üí° Customization Tips

| Area            | File                                 | Notes                                     |
| --------------- | ------------------------------------ | ----------------------------------------- |
| Theme colors    | `frontend/styles.css`                | Update `:root` variables                  |
| Animation speed | `frontend/styles.css`                | Adjust keyframe durations                 |
| Banner text     | `frontend/app.js` ‚Üí `createBanner()` | Customize call connect messages           |
| WS event logic  | `frontend/app.js` ‚Üí `bootWS()`       | Handle new event types or CRM popups      |
| Backend APIs    | `backend/main.py`                    | Add new routes (wrap-up, recording, etc.) |

---

## üîó GoHighLevel Integration

* When a call connects, the backend sends `ghlLocationID` and `ghlContactID` in the `connected` event.
* The frontend opens a new tab:

  ```
  https://app.gohighlevel.com/v2/location/<ghlLocationID>/contacts/detail/<ghlContactID>
  ```
* If either field is missing ‚Üí no popup occurs.

To disable automatic popups, comment out this block in `app.js`:

```js
if (evt.lead) {
  const { ghlLocationID, ghlContactID } = evt.lead;
  if (ghlLocationID && ghlContactID) openHighLevelContact(ghlLocationID, ghlContactID);
}
```

---

## üß† Common Troubleshooting

| Issue                     | Cause                                         | Fix                                                     |
| ------------------------- | --------------------------------------------- | ------------------------------------------------------- |
| **CORS error**            | ALLOWED_ORIGIN not set correctly              | Add frontend URL to Render backend env var              |
| **Login fails**           | Invalid credentials or missing Five9 env vars | Check `FIVE9_CLIENT_ID` / `FIVE9_CLIENT_SECRET`         |
| **No outbound campaigns** | Agent‚Äôs skill not found                       | Verify skill name ends with `_Blended_Inbound_Outbound` |
| **No banner on connect**  | WS events not emitting `connected`            | Add correct event forwarding from Five9                 |
| **No GHL popup**          | Missing IDs in event payload                  | Ensure Five9 record sync includes both fields           |

---

## üß© How to Extend

### 1Ô∏è‚É£ Add Wrap-Up / Disposition

* After `connected`, track Five9‚Äôs `onCallEnded` event.
* Show a modal with disposition options ‚Üí send result via `/agent/v2/calls/{id}/disposition`.

### 2Ô∏è‚É£ Add CRM Screen-Pop (optional)

* Load the Five9 CRM SDK (`crm-sdk-lib/js/script.js`).
* Subscribe to `InteractionApi` events for call/record data.

### 3Ô∏è‚É£ Integrate Reporting

* Use Five9‚Äôs `/reporting/v1` APIs for call stats, export to dashboard.

---

## üìÑ Release Workflow

1. Make edits locally and test via `uvicorn` + local static server.
2. Commit and push to GitHub.
3. Render auto-builds both services (frontend + backend).
4. Verify deployments and logs.
5. Tag releases in GitHub (`v1.0.0`, `v1.1.0`, etc.).

---

## üë• Team Notes

* Only store credentials as **Render environment variables** ‚Äî never commit secrets.
* Test using a **sandbox Five9 tenant** before deploying live.
* Branch naming convention: `feature/`, `bugfix/`, `release/`.

---

## ‚úÖ Quick Summary

| Component   | Purpose                                |
| ----------- | -------------------------------------- |
| Frontend    | Agent dialer UI (HTML/CSS/JS)          |
| Backend     | Secure API bridge to Five9             |
| Render      | Hosting platform (free tier supported) |
| Five9       | Telephony engine                       |
| GoHighLevel | CRM / lead management                  |

---

> **Nuvia Dialer** ‚Äî developed by the Nuvia Dental Implant Center tech team to modernize agent workflows, unify inbound/outbound activity visualization, and integrate Five9 with GoHighLevel.

```

---

### ‚úÖ What This Guide Covers
‚úî Complete system architecture  
‚úî Local development setup  
‚úî Real Five9 WS integration instructions  
‚úî Environment & deployment configuration  
‚úî Troubleshooting and common issues  
‚úî How to extend features  